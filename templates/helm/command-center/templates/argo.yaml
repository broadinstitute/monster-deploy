---
{{- $secretName := "db-password" }}
{{- $keyName := "password" }}
{{- $env := .Values.env }}
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: db-login-secrets
spec:
  releaseName: db-login-secrets
  targetNamespace: secrets-manager
  resetValues: true
  chart:
    repository: https://broadinstitute.github.io/datarepo-helm
    name: create-secret-manager-secret
    version: 0.0.5
  values:
    secrets:
      {{- range (append .Values.argoNamespaces "argo-ui") }}
      - secretName: {{ $secretName }}
        nameSpace: {{.}}
        vals:
          - kubeSecretKey: {{ $keyName }}
            path: secret/dsde/monster/{{ $env }}/command-center/cloudsql/users/argo
            vaultKey: password
      {{- end }}
{{- range .Values.argoNamespaces }}
---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: {{.}}-argo-controller
spec:
  releaseName: argo-controller
  targetNamespace: {{.}}
  resetValues: true
  chart:
    repository: https://broadinstitute.github.io/monster-helm
    name: argo-controller
    version: 0.1.0
  values:
    persistence:
      host: cloudsql-proxy-gcloud-sqlproxy.cloudsql-proxy
      port: 5432
      database: argo
      username: argo
      password:
        secretName: {{ $secretName }}
        secretKey: {{ $keyName }}
{{- end }}
---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: argo-server
spec:
  releaseName: argo-server
  targetNamespace: argo-ui
  resetValues: true
  chart:
    git: git://github.com/broadinstitute/monster-helm.git
    ref: dm-argo-server-DSPDC-672
    path: charts/argo-server
  values:
    persistence:
      host: cloudsql-proxy-gcloud-sqlproxy.cloudsql-proxy
      port: 5432
      database: argo
      username: argo
      password:
        secretName: {{ $secretName }}
        secretKey: {{ $keyName }}
